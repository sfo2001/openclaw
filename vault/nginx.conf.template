# Vault sidecar nginx config template.
#
# $VAR placeholders are replaced by entrypoint.sh via envsubst.
# Secrets are injected into proxy_set_header directives at startup.
#
# Each server block listens on a dedicated port and proxies to one API,
# injecting the correct auth header format.
#
# Adding a new provider:
#   1. Add an annotated server block below (see @vault annotation format)
#   2. Run tests â€” on mismatch, the sync test failure shows the line to add
#   3. Add the entry to src/vault/operations.ts
#
# Annotation format:  # @vault provider=<name> port=<N> secret=<ENV_VAR>
# entrypoint.sh auto-discovers $VAR placeholders from this template.

user nginx;
worker_processes 1;
error_log /dev/stderr warn;
pid /run/secrets/nginx.pid;

events {
    worker_connections 128;
}

http {
    server_tokens off;
    client_max_body_size 25m;

    # Custom log format: excludes query strings and Referer to prevent token leakage.
    log_format vault '$remote_addr - $remote_user [$time_local] '
                     '"$request_method $uri" $status $body_bytes_sent';
    access_log /dev/stdout vault;

    # Shared proxy defaults
    proxy_http_version 1.1;
    proxy_ssl_server_name on;
    proxy_buffering off;
    proxy_cache off;
    proxy_read_timeout 300s;
    proxy_send_timeout 60s;

    # Health check endpoint
    server {
        listen 5335;
        location /live {
            return 200 'ok';
        }
        location /ready {
            return 200 'ok';
        }
    }

    # @vault provider=openai port=8081 secret=OPENAI_API_KEY
    # Target: https://api.openai.com | Auth: Bearer
    server {
        listen 8081;

        # Restrict to known OpenAI API paths (defense-in-depth).
        # Prevents agent-injected requests from reaching arbitrary endpoints.
        location /v1/ {
            proxy_pass https://api.openai.com;
            proxy_set_header Host api.openai.com;
            proxy_set_header Authorization "Bearer ${OPENAI_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=anthropic port=8082 secret=ANTHROPIC_API_KEY
    # Target: https://api.anthropic.com | Auth: x-api-key
    server {
        listen 8082;

        location /v1/ {
            proxy_pass https://api.anthropic.com;
            proxy_set_header Host api.anthropic.com;
            proxy_set_header Authorization "";
            proxy_set_header x-api-key "${ANTHROPIC_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=deepgram port=8083 secret=DEEPGRAM_API_KEY
    # Target: https://api.deepgram.com | Auth: Token (WebSocket upgrade)
    server {
        listen 8083;

        location /v1/ {
            proxy_pass https://api.deepgram.com;
            proxy_set_header Host api.deepgram.com;
            proxy_set_header Authorization "Token ${DEEPGRAM_API_KEY}";
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=google port=8085 secret=GEMINI_API_KEY
    # Target: https://generativelanguage.googleapis.com | Auth: x-goog-api-key
    server {
        listen 8085;

        location /v1beta/ {
            proxy_pass https://generativelanguage.googleapis.com;
            proxy_set_header Host generativelanguage.googleapis.com;
            proxy_set_header Authorization "";
            proxy_set_header x-goog-api-key "${GEMINI_API_KEY}";
            proxy_set_header Connection "";
        }
        location /v1/ {
            proxy_pass https://generativelanguage.googleapis.com;
            proxy_set_header Host generativelanguage.googleapis.com;
            proxy_set_header Authorization "";
            proxy_set_header x-goog-api-key "${GEMINI_API_KEY}";
            proxy_set_header Connection "";
        }
        # The Google SDK sets apiVersion="" when baseUrl is overridden,
        # so requests arrive as /models/{model}:method without a version
        # prefix. Rewrite to /v1beta/models/ for the upstream API.
        location /models/ {
            proxy_pass https://generativelanguage.googleapis.com/v1beta/models/;
            proxy_set_header Host generativelanguage.googleapis.com;
            proxy_set_header Authorization "";
            proxy_set_header x-goog-api-key "${GEMINI_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=groq port=8086 secret=GROQ_API_KEY
    # Target: https://api.groq.com | Auth: Bearer
    server {
        listen 8086;

        location /openai/v1/ {
            proxy_pass https://api.groq.com;
            proxy_set_header Host api.groq.com;
            proxy_set_header Authorization "Bearer ${GROQ_API_KEY}";
            proxy_set_header Connection "";
        }
        location /v1/ {
            proxy_pass https://api.groq.com;
            proxy_set_header Host api.groq.com;
            proxy_set_header Authorization "Bearer ${GROQ_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=xai port=8087 secret=XAI_API_KEY
    # Target: https://api.x.ai | Auth: Bearer
    server {
        listen 8087;

        location /v1/ {
            proxy_pass https://api.x.ai;
            proxy_set_header Host api.x.ai;
            proxy_set_header Authorization "Bearer ${XAI_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=mistral port=8088 secret=MISTRAL_API_KEY
    # Target: https://api.mistral.ai | Auth: Bearer
    server {
        listen 8088;

        location /v1/ {
            proxy_pass https://api.mistral.ai;
            proxy_set_header Host api.mistral.ai;
            proxy_set_header Authorization "Bearer ${MISTRAL_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=brave port=8089 secret=BRAVE_API_KEY
    # Target: https://api.search.brave.com | Auth: X-Subscription-Token
    server {
        listen 8089;

        location /res/ {
            proxy_pass https://api.search.brave.com;
            proxy_set_header Host api.search.brave.com;
            proxy_set_header Authorization "";
            proxy_set_header X-Subscription-Token "${BRAVE_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=perplexity port=8090 secret=PERPLEXITY_API_KEY
    # Target: https://api.perplexity.ai | Auth: Bearer
    server {
        listen 8090;

        location /chat/ {
            proxy_pass https://api.perplexity.ai;
            proxy_set_header Host api.perplexity.ai;
            proxy_set_header Authorization "Bearer ${PERPLEXITY_API_KEY}";
            proxy_set_header Connection "";
        }
        location /v1/ {
            proxy_pass https://api.perplexity.ai;
            proxy_set_header Host api.perplexity.ai;
            proxy_set_header Authorization "Bearer ${PERPLEXITY_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=openai-compat port=8084 secret=OPENAI_COMPAT_API_KEY
    # Target: https://openrouter.ai (configurable) | Auth: Bearer
    server {
        listen 8084;

        location /v1/ {
            proxy_pass https://openrouter.ai;
            proxy_set_header Host openrouter.ai;
            proxy_set_header Authorization "Bearer ${OPENAI_COMPAT_API_KEY}";
            proxy_set_header Connection "";
        }
        location /api/ {
            proxy_pass https://openrouter.ai;
            proxy_set_header Host openrouter.ai;
            proxy_set_header Authorization "Bearer ${OPENAI_COMPAT_API_KEY}";
            proxy_set_header Connection "";
        }
        location / {
            return 403 'path not allowed';
        }
    }

    # @vault provider=home-assistant port=8091 secret=HA_TOKEN
    # Target: configurable via HA_UPSTREAM_URL environment variable
    # Auth: Authorization: Bearer <long-lived access token>
    #
    # HA_UPSTREAM_URL is set via docker-compose environment (not a secret).
    # HA_TOKEN is the long-lived access token from vault.age.
    server {
        listen 8091;

        location / {
            proxy_pass ${HA_UPSTREAM_URL};
            proxy_set_header Authorization "Bearer ${HA_TOKEN}";
            proxy_set_header Connection "";
        }
    }
}
